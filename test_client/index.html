<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API æµ‹è¯•æ§åˆ¶å°</title>
    <style>
        :root {
            --primary-color: #3f51b5;
            --success-color: #4caf50;
            --error-color: #f44336;
            --bg-color: #f5f5f5;
            --card-bg: #ffffff;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 20px;
            color: #333;
            max-width: 1200px;
            margin: 0 auto;
        }
        h1, h2, h3 { color: var(--primary-color); }
        .config-bar {
            background: var(--card-bg);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        input[type="text"], input[type="password"] {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 100%;
            box-sizing: border-box;
            margin-bottom: 10px;
        }
        button {
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            background-color: var(--primary-color);
            color: white;
            transition: opacity 0.3s;
        }
        button:hover { opacity: 0.9; }
        button.danger { background-color: var(--error-color); }
        button.success { background-color: var(--success-color); }
        
        .grid-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .response-area {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Consolas', 'Monaco', monospace;
            height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        .hidden { display: none; }
        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            background: #eee;
            font-size: 12px;
            margin-left: 5px;
        }
        .token-display {
            word-break: break-all;
            font-size: 10px;
            color: #888;
            margin-top: 5px;
        }
    </style>
</head>
<body>

    <div class="config-bar">
        <label>API åŸºç¡€åœ°å€:</label>
        <input type="text" id="baseUrl" value="http://localhost:8080" style="width: 250px; margin-bottom: 0;">
        <span id="authStatus" class="badge">æœªç™»å½•</span>
    </div>

    <div class="grid-container">
        <!-- å·¦ä¾§ï¼šæ“ä½œè¡¨å• -->
        <div class="left-panel">
            
            <!-- æ³¨å†Œ/ç™»å½• -->
            <div id="authSection" class="card">
                <h2>ğŸ‘¤ è®¤è¯</h2>
                <div style="display: flex; gap: 10px; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px;">
                    <button onclick="showTab('login')" id="btnLoginTab">ç™»å½•</button>
                    <button onclick="showTab('register')" id="btnRegisterTab" style="background-color: #ddd; color: #333;">æ³¨å†Œ</button>
                </div>

                <!-- ç™»å½•è¡¨å• -->
                <div id="loginForm">
                    <input type="text" id="loginAccount" placeholder="è´¦å·">
                    <input type="password" id="loginPassword" placeholder="å¯†ç ">
                    <button onclick="login()" class="success">ç™»å½•</button>
                </div>

                <!-- æ³¨å†Œè¡¨å• -->
                <div id="registerForm" class="hidden">
                    <input type="text" id="regAccount" placeholder="è´¦å·">
                    <input type="text" id="regName" placeholder="æ˜µç§°">
                    <input type="password" id="regPassword" placeholder="å¯†ç ">
                    <button onclick="register()">æ³¨å†Œ</button>
                </div>
            </div>

            <!-- ç”¨æˆ·åŠŸèƒ½ (ç™»å½•åæ˜¾ç¤º) -->
            <div id="userSection" class="hidden">
                <div class="card">
                    <h2>ğŸ“‹ ä¸ªäººä¿¡æ¯ <button onclick="getProfile()" style="float: right; padding: 5px 10px; font-size: 12px;">åˆ·æ–°</button></h2>
                    <div id="profileView">
                        <p>è¯·ç‚¹å‡»åˆ·æ–°è·å–æ•°æ®...</p>
                    </div>
                    <div class="token-display" id="tokenDisplay"></div>
                    <div style="margin-top: 10px;">
                        <button onclick="logout()" class="danger">é€€å‡ºç™»å½•</button>
                    </div>
                </div>

                <div class="card">
                    <h2>âœï¸ ä¿®æ”¹èµ„æ–™</h2>
                    
                    <h3>ä¿®æ”¹ç”¨æˆ·æ˜µç§°</h3>
                    <div style="display: flex; gap: 5px;">
                        <input type="text" id="newName" placeholder="æ–°æ˜µç§°">
                        <button onclick="changeName()">ä¿®æ”¹</button>
                    </div>

                    <h3>ä¿®æ”¹ä¸ªæ€§ç­¾å (Introduction)</h3>
                    <div style="display: flex; gap: 5px;">
                        <input type="text" id="newIntro" placeholder="æ–°ç­¾å">
                        <button onclick="changeIntro()">ä¿®æ”¹</button>
                    </div>
                    
                    <h3>ä¿®æ”¹å¤´åƒ (ä¸Šä¼ æ–‡ä»¶)</h3>
                    <div style="display: flex; gap: 5px; align-items: center;">
                        <input type="file" id="newAvatarFile" accept="image/*">
                        <button onclick="changeAvatar()">ä¸Šä¼ </button>
                    </div>

                    <h3>ä¿®æ”¹å¯†ç </h3>
                    <input type="password" id="oldPass" placeholder="æ—§å¯†ç  (APIä¼¼ä¹æ²¡ç”¨åˆ°æ—§å¯†ç æ ¡éªŒ?)" disabled style="background-color: #eee;">
                    <input type="password" id="newPass1" placeholder="æ–°å¯†ç ">
                    <input type="password" id="newPass2" placeholder="ç¡®è®¤æ–°å¯†ç ">
                    <button onclick="changePassword()" class="danger">é‡ç½®å¯†ç </button>
                </div>

                <div class="card">
                    <h2>âš ï¸ å±é™©æ“ä½œ</h2>
                    <button onclick="deleteUser()" class="danger">æ³¨é”€è´¦å· (Delete User)</button>
                </div>
            </div>
        </div>

        <!-- å³ä¾§ï¼šæ—¥å¿—è¾“å‡º -->
        <div class="right-panel">
            <div class="card">
                <h2>ğŸ“¡ è¯·æ±‚æ—¥å¿—</h2>
                <div style="margin-bottom: 10px;">
                    <button onclick="clearLog()" style="background-color: #666; font-size: 12px; padding: 5px 10px;">æ¸…ç©ºæ—¥å¿—</button>
                </div>
                <div id="logArea" class="response-area">æš‚æ— è¯·æ±‚...</div>
            </div>
        </div>
    </div>

    <script>
        // ç§»é™¤å…¨å±€ token å˜é‡ï¼Œæ”¹ä¸ºæ¯æ¬¡è¯·æ±‚åŠ¨æ€è·å–
        // let token = localStorage.getItem('token') || '';

        // åˆå§‹åŒ–
        const initToken = localStorage.getItem('token');
        if (initToken) {
            updateAuthStatus(true);
            document.getElementById('tokenDisplay').innerText = "Token: " + initToken;
            // è‡ªåŠ¨æ‹‰å–ä¸€æ¬¡ç”¨æˆ·ä¿¡æ¯
            setTimeout(getProfile, 500);
        }

        function getBaseUrl() {
            return document.getElementById('baseUrl').value.replace(/\/$/, '');
        }

        function log(title, data, isError = false) {
            const logArea = document.getElementById('logArea');
            const time = new Date().toLocaleTimeString();
            const color = isError ? '#ff6b6b' : '#69f0ae';
            const content = typeof data === 'object' ? JSON.stringify(data, null, 2) : data;
            
            const entry = `\n[${time}] ${title}\n${content}\n----------------------------------------`;
            logArea.innerText = entry + logArea.innerText;
        }

        function clearLog() {
            document.getElementById('logArea').innerText = '';
        }

        function updateAuthStatus(isLoggedIn) {
            const badge = document.getElementById('authStatus');
            const userSection = document.getElementById('userSection');
            const authSection = document.getElementById('authSection');

            if (isLoggedIn) {
                badge.innerText = "å·²ç™»å½•";
                badge.style.backgroundColor = "#4caf50";
                badge.style.color = "white";
                userSection.classList.remove('hidden');
                authSection.classList.add('hidden');
            } else {
                badge.innerText = "æœªç™»å½•";
                badge.style.backgroundColor = "#eee";
                badge.style.color = "#333";
                userSection.classList.add('hidden');
                authSection.classList.remove('hidden');
                document.getElementById('tokenDisplay').innerText = "";
            }
        }

        function showTab(tab) {
            if(tab === 'login') {
                document.getElementById('loginForm').classList.remove('hidden');
                document.getElementById('registerForm').classList.add('hidden');
                document.getElementById('btnLoginTab').style.backgroundColor = 'var(--primary-color)';
                document.getElementById('btnLoginTab').style.color = 'white';
                document.getElementById('btnRegisterTab').style.backgroundColor = '#ddd';
                document.getElementById('btnRegisterTab').style.color = '#333';
            } else {
                document.getElementById('loginForm').classList.add('hidden');
                document.getElementById('registerForm').classList.remove('hidden');
                document.getElementById('btnRegisterTab').style.backgroundColor = 'var(--primary-color)';
                document.getElementById('btnRegisterTab').style.color = 'white';
                document.getElementById('btnLoginTab').style.backgroundColor = '#ddd';
                document.getElementById('btnLoginTab').style.color = '#333';
            }
        }

        async function request(endpoint, method = 'GET', data = null) {
            const url = getBaseUrl() + endpoint;
            const headers = {
                // 'Content-Type': 'application/json' // é»˜è®¤å€¼ï¼Œä¸‹é¢é€»è¾‘ä¼šè°ƒæ•´
            };
            
            // æ¯æ¬¡è¯·æ±‚éƒ½ä» LocalStorage è·å–æœ€æ–° Token
            const currentToken = localStorage.getItem('token');
            if (currentToken) {
                headers['Authorization'] = 'Bearer ' + currentToken;
            }

            const options = {
                method,
                headers,
                credentials: 'include', // å…è®¸å‘é€å’Œæ¥æ”¶ Cookie (ç”¨äº Refresh Token)
            };

            if (data instanceof FormData) {
                // å¦‚æœæ˜¯ FormDataï¼Œä¸è¦æ‰‹åŠ¨è®¾ç½® Content-Typeï¼Œæµè§ˆå™¨ä¼šè‡ªåŠ¨å¤„ç†è¾¹ç•Œ(boundary)
                options.body = data;
            } else {
                // é»˜è®¤ JSON æ ¼å¼
                headers['Content-Type'] = 'application/json';
                if (data) {
                    options.body = JSON.stringify(data);
                }
            }

            log(`>>> ${method} ${endpoint}`, data instanceof FormData ? '[FormData File]' : (data || '(no body)'));

            try {
                const res = await fetch(url, options);
                const resData = await res.json();
                
                if (res.ok) {
                    log(`<<< ${res.status} OK`, resData);
                    return resData;
                } else {
                    log(`<<< ${res.status} Error`, resData, true);
                    alert("æ“ä½œå¤±è´¥: " + (resData.msg || "æœªçŸ¥é”™è¯¯"));
                    return null;
                }
            } catch (error) {
                log(`<<< Network Error`, error, true);
                alert("ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥åç«¯æ˜¯å¦å¯åŠ¨");
                return null;
            }
        }

        // ================= ä¸šåŠ¡é€»è¾‘ =================

        async function register() {
            const account = document.getElementById('regAccount').value;
            const name = document.getElementById('regName').value;
            const password = document.getElementById('regPassword').value;

            if(!account || !password || !name) return alert("è¯·å¡«å†™å®Œæ•´");

            const res = await request('/account/register', 'POST', { account, name, password });
            if (res && res.code === 0) { // å‡è®¾ 0 æ˜¯æˆåŠŸ
                alert("æ³¨å†ŒæˆåŠŸï¼Œè¯·ç™»å½•");
                showTab('login');
                document.getElementById('loginAccount').value = account;
            }
        }

        async function login() {
            const account = document.getElementById('loginAccount').value;
            const password = document.getElementById('loginPassword').value;

            if(!account || !password) return alert("è¯·å¡«å†™å®Œæ•´");

            const res = await request('/account/login', 'POST', { account, password });
            if (res && res.code === 0) {
                // ç¡®ä¿æ­£ç¡®æå– Tokenï¼Œå› ä¸ºä¸åŒåç«¯å¯èƒ½è¿”å›ç»“æ„ä¸åŒ (string vs object)
                let finalToken = "";
                if (typeof res.data === 'string') {
                    finalToken = res.data;
                } else if (res.data && res.data.token) {
                    finalToken = res.data.token;
                } else {
                    console.warn("ç™»å½•è¿”å›çš„ Data ç»“æ„ä¸ç¬¦åˆé¢„æœŸ:", res.data);
                    // å°è¯•ä½œä¸ºå­—ç¬¦ä¸²å…œåº•
                    finalToken = String(res.data);
                }

                if(finalToken) {
                    localStorage.setItem('token', finalToken);
                    updateAuthStatus(true);
                    document.getElementById('tokenDisplay').innerText = "Token: " + finalToken;
                    getProfile();
                } else {
                    alert("ç™»å½•å¤±è´¥: æ— æ³•è·å– Token");
                }
            }
        }

        function logout() {
            // è°ƒç”¨åç«¯ç™»å‡ºï¼ˆå¦‚æœéœ€è¦ï¼‰
            request('/account/protected/logout', 'POST'); 
            localStorage.removeItem('token');
            updateAuthStatus(false);
            alert("å·²é€€å‡º");
        }

        async function getProfile() {
            const res = await request('/account/protected/profile', 'GET');
            if (res && res.code === 0) {
                const user = res.data;
                
                // å¤„ç†å¤´åƒ URL: å¦‚æœæ˜¯ç›¸å¯¹è·¯å¾„ï¼Œæ‹¼æ¥ä¸Š BaseURL
                let avatarSrc = user.Avatar;
                if (avatarSrc && !avatarSrc.startsWith('http')) {
                   avatarSrc = getBaseUrl() + avatarSrc;
                }
                // å¦‚æœæ²¡æœ‰å¤´åƒï¼Œä½¿ç”¨é»˜è®¤å ä½å›¾
                if (!avatarSrc) {
                    avatarSrc = 'https://via.placeholder.com/150?text=No+Avatar';
                }

                const html = `
                    <div style="display: flex; align-items: flex-start; gap: 15px;">
                        <div style="flex-shrink: 0;">
                            <img src="${avatarSrc}" alt="Avatar" style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 2px solid #ddd; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        </div>
                        <div style="flex-grow: 1;">
                            <p style="margin: 0 0 5px 0;"><strong>è´¦å·:</strong> ${user.Account} <span class="badge" style="background:${user.Role === 1 ? '#ff9800' : '#2196f3'};color:white;">${user.Role === 1 ? 'ç®¡ç†å‘˜' : 'æ™®é€šç”¨æˆ·'}</span></p>
                            <p style="margin: 5px 0;"><strong>æ˜µç§°:</strong> ${user.Name}</p>
                            <p style="margin: 5px 0; color: #666; font-size: 0.9em;"><strong>ç®€ä»‹:</strong> ${user.Introduction || 'è¿™ä¸ªäººå¾ˆæ‡’ï¼Œä»€ä¹ˆéƒ½æ²¡å†™'}</p>
                        </div>
                    </div>
                `;
                document.getElementById('profileView').innerHTML = html;
            }
        }

        async function changeName() {
            const name = document.getElementById('newName').value;
            if(!name) return;
            const res = await request('/account/protected/username', 'PATCH', { name });
            if(res && res.code === 0) {
                alert("ä¿®æ”¹æˆåŠŸ");
                getProfile();
            }
        }

        async function changeIntro() {
            const introduction = document.getElementById('newIntro').value;
            if(!introduction) return;
            const res = await request('/account/protected/introduction', 'PATCH', { introduction });
            if(res && res.code === 0) {
                alert("ä¿®æ”¹æˆåŠŸ");
                getProfile();
            }
        }
        
        async function changeAvatar() {
            const fileInput = document.getElementById('newAvatarFile');
            if(fileInput.files.length === 0) return alert("è¯·é€‰æ‹©è¦ä¸Šä¼ çš„å›¾ç‰‡æ–‡ä»¶");

            // æ„å»º FormData
            const formData = new FormData();
            formData.append('avatar', fileInput.files[0]); // åç«¯ api.go ä¸­ä½¿ç”¨çš„æ˜¯ c.FormFile("avatar")

            const res = await request('/account/protected/avatar', 'POST', formData);
            if(res && res.code === 0) {
                alert("å¤´åƒä¿®æ”¹æˆåŠŸ");
                getProfile();
            }
        }

        async function changePassword() {
            const pw1 = document.getElementById('newPass1').value;
            const pw2 = document.getElementById('newPass2').value;
            
            if(!pw1 || !pw2) return alert("è¯·è¾“å…¥æ–°å¯†ç ");
            if(pw1 !== pw2) return alert("ä¸¤æ¬¡éªŒè¯å¯†ç ä¸ä¸€è‡´");

            // æ³¨æ„ï¼šè¿™é‡ŒæŒ‰ç…§æˆ‘ä»¬ä¹‹å‰è®¨è®ºçš„ UserPassword ç»“æ„ä½“æ¥ä¼ å‚
            // json tag æ˜¯ first_password å’Œ second_password
            const res = await request('/account/protected/password-change', 'POST', {
                first_password: pw1,
                second_password: pw2
            });
            
            if(res && res.code === 0) {
                alert("å¯†ç ä¿®æ”¹æˆåŠŸ");
            }
        }

        async function deleteUser() {
            if(!confirm("ç¡®å®šè¦æ³¨é”€è´¦å·å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼")) return;
            const res = await request('/account/protected/delete-user', 'DELETE');
            if(res && res.code === 0) {
                alert("è´¦å·å·²æ³¨é”€");
                logout();
            }
        }

    </script>
</body>
</html>
