<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¤¾åŒº - API æµ‹è¯•æ§åˆ¶å°</title>
    <style>
        :root {
            --primary-color: #0066ff;
            --success-color: #4caf50;
            --error-color: #f44336;
            --bg-color: #f6f6f6;
            --card-bg: #ffffff;
            --text-color: #1a1a1a;
            --text-secondary: #999;
            --border-color: #e8e8e8;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Microsoft YaHei', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
        }

        /* é¡¶éƒ¨å¯¼èˆª */
        .navbar {
            background: var(--card-bg);
            border-bottom: 1px solid var(--border-color);
            padding: 0 20px;
            height: 52px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .navbar .logo { font-size: 20px; font-weight: 700; color: var(--primary-color); }
        .navbar .nav-right { display: flex; align-items: center; gap: 12px; }
        .navbar .nav-right button { font-size: 13px; padding: 6px 14px; }

        /* æŒ‰é’® */
        button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            background-color: var(--primary-color);
            color: white;
            font-size: 14px;
            transition: opacity 0.2s;
        }
        button:hover { opacity: 0.85; }
        button.danger { background-color: var(--error-color); }
        button.success { background-color: var(--success-color); }
        button.ghost { background: transparent; color: var(--primary-color); border: 1px solid var(--primary-color); }
        button.ghost-danger { background: transparent; color: var(--error-color); border: 1px solid var(--error-color); }
        button.small { font-size: 12px; padding: 4px 10px; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }

        /* è¾“å…¥æ¡† */
        input[type="text"], input[type="password"], textarea {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            width: 100%;
            font-size: 14px;
            font-family: inherit;
            outline: none;
            transition: border-color 0.2s;
        }
        input:focus, textarea:focus { border-color: var(--primary-color); }
        textarea { resize: vertical; min-height: 80px; }

        /* å¸ƒå±€ */
        .container {
            max-width: 1100px;
            margin: 0 auto;
            padding: 20px;
        }
        .main-layout {
            display: grid;
            grid-template-columns: 1fr 320px;
            gap: 20px;
            align-items: start;
        }
        .card {
            background: var(--card-bg);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            padding: 20px;
            margin-bottom: 16px;
        }
        .card h2 { font-size: 16px; margin-bottom: 16px; padding-bottom: 10px; border-bottom: 1px solid var(--border-color); }
        .card h3 { font-size: 14px; margin: 14px 0 8px 0; color: #555; }

        .hidden { display: none !important; }
        .badge {
            display: inline-block; padding: 2px 8px; border-radius: 10px;
            font-size: 11px; font-weight: 600;
        }

        /* é¡µé¢/è§†å›¾åˆ‡æ¢ */
        .page { display: none; }
        .page.active { display: block; }

        /* ===== è®¤è¯é¡µ ===== */
        .auth-page {
            max-width: 380px;
            margin: 80px auto;
        }
        .auth-page .card { padding: 30px; }
        .auth-page .tabs { display: flex; gap: 0; margin-bottom: 20px; }
        .auth-page .tabs button {
            flex: 1; border-radius: 0; background: #f0f0f0; color: #666;
        }
        .auth-page .tabs button.active { background: var(--primary-color); color: white; }
        .auth-page .tabs button:first-child { border-radius: 4px 0 0 4px; }
        .auth-page .tabs button:last-child { border-radius: 0 4px 4px 0; }
        .auth-page .form-group { margin-bottom: 12px; }
        .auth-page .form-group label { display: block; font-size: 13px; color: #666; margin-bottom: 4px; }
        .auth-page button.submit-btn { width: 100%; margin-top: 8px; padding: 10px; }

        /* ===== å¸–å­åˆ—è¡¨ ===== */
        .post-item {
            padding: 16px 0;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background 0.1s;
        }
        .post-item:last-child { border-bottom: none; }
        .post-item:hover { background: #fafafa; margin: 0 -20px; padding: 16px 20px; }
        .post-item .post-meta {
            display: flex; align-items: center; gap: 8px; margin-bottom: 8px; font-size: 13px; color: var(--text-secondary);
        }
        .post-item .post-meta img { width: 24px; height: 24px; border-radius: 50%; object-fit: cover; }
        .post-item .post-meta .author-name { color: var(--text-color); font-weight: 500; cursor: pointer; }
        .post-item .post-meta .author-name:hover { color: var(--primary-color); }
        .post-item .post-title { font-size: 16px; font-weight: 600; margin-bottom: 6px; color: var(--text-color); }
        .post-item .post-title:hover { color: var(--primary-color); }
        .post-item .post-stats { display: flex; gap: 16px; font-size: 13px; color: var(--text-secondary); }

        /* ===== å¸–å­è¯¦æƒ… ===== */
        .post-detail .post-header { margin-bottom: 20px; }
        .post-detail .post-header h1 { font-size: 22px; line-height: 1.4; margin-bottom: 12px; }
        .post-detail .post-author {
            display: flex; align-items: center; gap: 10px; padding: 10px 0; border-bottom: 1px solid var(--border-color);
        }
        .post-detail .post-author img { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; cursor: pointer; }
        .post-detail .post-author .info .name { font-weight: 600; cursor: pointer; }
        .post-detail .post-author .info .name:hover { color: var(--primary-color); }
        .post-detail .post-content { padding: 20px 0; line-height: 1.8; font-size: 15px; white-space: pre-wrap; word-break: break-word; }
        .post-detail .post-actions { display: flex; gap: 10px; padding: 10px 0; border-top: 1px solid var(--border-color); }

        /* è¯„è®º */
        .comment-section { margin-top: 20px; }
        .comment-section h3 { font-size: 16px; margin-bottom: 16px; }
        .comment-input-area { display: flex; flex-direction: column; gap: 8px; margin-bottom: 20px; }
        .comment-item {
            display: flex; gap: 10px; padding: 12px 0; border-bottom: 1px solid #f0f0f0;
        }
        .comment-item img { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; flex-shrink: 0; cursor: pointer; }
        .comment-item .comment-body { flex: 1; }
        .comment-item .comment-body .comment-author { font-size: 13px; font-weight: 600; margin-bottom: 4px; }
        .comment-item .comment-body .comment-author:hover { color: var(--primary-color); cursor: pointer; }
        .comment-item .comment-body .comment-text { font-size: 14px; line-height: 1.6; }
        .comment-item .comment-body .comment-time { font-size: 12px; color: var(--text-secondary); margin-top: 4px; }
        .comment-item .comment-actions { display: flex; gap: 8px; margin-top: 6px; }

        /* ===== ç”¨æˆ·ä¸»é¡µ ===== */
        .profile-header {
            display: flex; align-items: center; gap: 20px; margin-bottom: 20px;
        }
        .profile-header img { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 3px solid var(--border-color); }
        .profile-header .info h2 { font-size: 20px; margin-bottom: 4px; border: none; padding: 0; }
        .profile-header .info p { color: var(--text-secondary); font-size: 14px; }

        /* ===== ä¾§è¾¹æ  ===== */
        .sidebar .card { position: sticky; top: 72px; }
        .sidebar .user-card {
            display: flex; align-items: center; gap: 10px; margin-bottom: 12px;
        }
        .sidebar .user-card img { width: 48px; height: 48px; border-radius: 50%; object-fit: cover; }
        .sidebar .user-card .name { font-weight: 600; font-size: 15px; }
        .sidebar .user-card .role { font-size: 12px; color: var(--text-secondary); }
        .sidebar .menu { list-style: none; }
        .sidebar .menu li {
            padding: 10px 0; border-bottom: 1px solid #f0f0f0; cursor: pointer; font-size: 14px;
        }
        .sidebar .menu li:hover { color: var(--primary-color); }
        .sidebar .menu li:last-child { border-bottom: none; }

        /* ===== æ—¥å¿—é¢æ¿ ===== */
        .log-panel {
            position: fixed; bottom: 0; left: 0; right: 0; z-index: 200;
            background: #1e1e1e; color: #d4d4d4;
            max-height: 0; overflow: hidden;
            transition: max-height 0.3s ease;
        }
        .log-panel.open { max-height: 300px; }
        .log-panel .log-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 8px 16px; background: #2d2d2d; cursor: pointer;
        }
        .log-panel .log-header span { font-size: 13px; font-weight: 600; }
        .log-panel .log-content {
            padding: 10px 16px; height: 250px; overflow-y: auto;
            font-family: 'Consolas', 'Monaco', monospace; font-size: 12px;
            white-space: pre-wrap;
        }
        .log-toggle {
            position: fixed; bottom: 10px; right: 20px; z-index: 201;
            border-radius: 50%; width: 40px; height: 40px; padding: 0;
            font-size: 18px; background: #333; color: #fff;
            display: flex; align-items: center; justify-content: center;
        }
        .log-panel.open ~ .log-toggle { bottom: 310px; }

        /* åˆ†é¡µ */
        .pagination { display: flex; justify-content: center; gap: 8px; padding: 16px 0; }

        /* è¡¨å•è¡Œ */
        .form-row { display: flex; gap: 8px; margin-bottom: 10px; }
        .form-row input, .form-row textarea { flex: 1; }

        /* åŠ è½½æç¤º */
        .loading { text-align: center; padding: 40px; color: var(--text-secondary); }

        /* toast */
        .toast {
            position: fixed; top: 70px; right: 20px; z-index: 300;
            background: #333; color: white; padding: 12px 20px; border-radius: 6px;
            font-size: 14px; transform: translateX(120%); transition: transform 0.3s;
        }
        .toast.show { transform: translateX(0); }
        .toast.error { background: var(--error-color); }
        .toast.success { background: var(--success-color); }

        /* ç‚¹èµæŒ‰é’® */
        .like-btn { transition: all 0.2s; }
        .like-btn.liked { background: #ff4757; border-color: #ff4757; color: white; }
        .like-btn.liked:hover { background: #ff6b81; }

        /* å…³æ³¨æŒ‰é’® */
        .follow-btn { transition: all 0.2s; min-width: 70px; }
        .follow-btn.following { background: #e0e0e0; color: #666; border-color: #ccc; }
        .follow-btn.following:hover { background: #ffebee; color: var(--error-color); border-color: var(--error-color); }

        /* Tab åˆ‡æ¢æ  */
        .feed-tabs { display: flex; gap: 0; margin-bottom: 16px; border-bottom: 2px solid var(--border-color); }
        .feed-tabs button {
            background: transparent; color: var(--text-secondary); border: none; border-bottom: 2px solid transparent;
            padding: 10px 20px; font-size: 14px; font-weight: 500; margin-bottom: -2px; border-radius: 0;
        }
        .feed-tabs button.active { color: var(--primary-color); border-bottom-color: var(--primary-color); }
        .feed-tabs button:hover { color: var(--primary-color); }

        /* çƒ­åº¦æ¦œ */
        .hot-rank-item {
            display: flex; align-items: center; gap: 10px; padding: 10px 0;
            border-bottom: 1px solid #f0f0f0; cursor: pointer;
        }
        .hot-rank-item:last-child { border-bottom: none; }
        .hot-rank-item:hover { background: #fafafa; margin: 0 -10px; padding: 10px; }
        .hot-rank-item .rank-num {
            width: 24px; height: 24px; border-radius: 4px; display: flex; align-items: center; justify-content: center;
            font-size: 12px; font-weight: 700; color: white; flex-shrink: 0;
        }
        .hot-rank-item .rank-num.top1 { background: #ff4757; }
        .hot-rank-item .rank-num.top2 { background: #ff6348; }
        .hot-rank-item .rank-num.top3 { background: #ffa502; }
        .hot-rank-item .rank-num.normal { background: #aaa; }
        .hot-rank-item .rank-info { flex: 1; min-width: 0; }
        .hot-rank-item .rank-info .rank-title { font-size: 13px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .hot-rank-item .rank-info .rank-score { font-size: 11px; color: var(--text-secondary); }

        /* å…³æ³¨/ç²‰ä¸åˆ—è¡¨ */
        .follow-list-item {
            display: flex; align-items: center; gap: 12px; padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        .follow-list-item:last-child { border-bottom: none; }
        .follow-list-item img { width: 44px; height: 44px; border-radius: 50%; object-fit: cover; cursor: pointer; }
        .follow-list-item .follow-info { flex: 1; min-width: 0; }
        .follow-list-item .follow-info .follow-name { font-weight: 600; font-size: 14px; cursor: pointer; }
        .follow-list-item .follow-info .follow-name:hover { color: var(--primary-color); }
        .follow-list-item .follow-info .follow-intro { font-size: 12px; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        @media (max-width: 768px) {
            .main-layout { grid-template-columns: 1fr; }
            .sidebar { order: -1; }
        }

        .config-bar {
            background: #fff3cd; padding: 8px 16px; font-size: 12px;
            display: flex; align-items: center; gap: 8px; border-bottom: 1px solid #ffc107;
        }
        .config-bar input { width: 200px; margin-bottom: 0; font-size: 12px; padding: 4px 8px; }

        /* å›¾ç‰‡ä¸Šä¼  */
        .upload-toolbar {
            display: flex; align-items: center; gap: 8px; margin-bottom: 8px;
        }
        .upload-toolbar label {
            display: inline-flex; align-items: center; gap: 4px;
            padding: 4px 12px; border: 1px solid var(--border-color); border-radius: 4px;
            font-size: 13px; cursor: pointer; color: #555; background: #fafafa;
            transition: border-color 0.2s, background 0.2s;
        }
        .upload-toolbar label:hover { border-color: var(--primary-color); background: #f0f5ff; color: var(--primary-color); }
        .upload-toolbar .upload-status { font-size: 12px; color: var(--text-secondary); }
        .image-preview-area {
            display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 8px;
        }
        .image-preview-area .preview-item {
            position: relative; width: 80px; height: 80px; border-radius: 6px;
            overflow: hidden; border: 1px solid var(--border-color);
        }
        .image-preview-area .preview-item img {
            width: 100%; height: 100%; object-fit: cover;
        }
        .image-preview-area .preview-item .remove-btn {
            position: absolute; top: 2px; right: 2px; width: 20px; height: 20px;
            border-radius: 50%; background: rgba(0,0,0,0.6); color: white;
            font-size: 12px; display: flex; align-items: center; justify-content: center;
            cursor: pointer; padding: 0; border: none; line-height: 1;
        }
        .image-preview-area .preview-item .remove-btn:hover { background: var(--error-color); }
        /* å¸–å­/è¯„è®ºå†…å®¹ä¸­çš„å›¾ç‰‡ */
        .rich-content img {
            max-width: 100%; border-radius: 6px; margin: 8px 0; cursor: pointer;
        }
        .rich-content img:hover { opacity: 0.9; }
    </style>
</head>
<body>

    <!-- é…ç½®æ  -->
    <div class="config-bar">
        <span>âš™ï¸ APIåœ°å€:</span>
        <input type="text" id="baseUrl" value="http://localhost:8080">
    </div>

    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <nav class="navbar">
        <div class="logo" onclick="navigateTo('feed')" style="cursor:pointer;">ğŸ’¬ ç¤¾åŒº</div>
        <div class="nav-right">
            <!-- æœªç™»å½• -->
            <div id="navGuest">
                <button onclick="navigateTo('auth')" class="ghost">ç™»å½•/æ³¨å†Œ</button>
            </div>
            <!-- å·²ç™»å½• -->
            <div id="navUser" class="hidden">
                <button onclick="navigateTo('create-post')" class="success small">âœï¸ å‘å¸–</button>
                <button onclick="navigateTo('my-profile')" class="ghost small">æˆ‘çš„ä¸»é¡µ</button>
                <button onclick="navigateTo('settings')" class="ghost small">âš™ è®¾ç½®</button>
                <button onclick="doLogout()" class="ghost-danger small">é€€å‡º</button>
            </div>
        </div>
    </nav>

    <div class="container">

        <!-- ====== è®¤è¯é¡µ ====== -->
        <div id="page-auth" class="page auth-page">
            <div class="card">
                <div class="tabs">
                    <button id="tabLogin" class="active" onclick="switchAuthTab('login')">ç™»å½•</button>
                    <button id="tabRegister" onclick="switchAuthTab('register')">æ³¨å†Œ</button>
                </div>
                <div id="formLogin">
                    <div class="form-group"><label>è´¦å·</label><input type="text" id="loginAccount" placeholder="è¯·è¾“å…¥è´¦å·"></div>
                    <div class="form-group"><label>å¯†ç </label><input type="password" id="loginPassword" placeholder="è¯·è¾“å…¥å¯†ç "></div>
                    <button class="submit-btn success" onclick="doLogin()">ç™»å½•</button>
                </div>
                <div id="formRegister" class="hidden">
                    <div class="form-group"><label>è´¦å·</label><input type="text" id="regAccount" placeholder="è¯·è¾“å…¥è´¦å·"></div>
                    <div class="form-group"><label>æ˜µç§°</label><input type="text" id="regName" placeholder="è¯·è¾“å…¥æ˜µç§°"></div>
                    <div class="form-group"><label>å¯†ç </label><input type="password" id="regPassword" placeholder="è¯·è¾“å…¥å¯†ç "></div>
                    <button class="submit-btn" onclick="doRegister()">æ³¨å†Œ</button>
                </div>
            </div>
        </div>

        <!-- ====== å¸–å­åˆ—è¡¨ (Feed) ====== -->
        <div id="page-feed" class="page main-layout">
            <div class="feed-main">
                <div class="card">
                    <div class="feed-tabs">
                        <button id="tabLatest" class="active" onclick="switchFeedTab('latest')">ğŸ“° æœ€æ–°å¸–å­</button>
                        <button id="tabFollowing" onclick="switchFeedTab('following')">ğŸ‘¥ å…³æ³¨åŠ¨æ€</button>
                    </div>
                    <div id="postList"><div class="loading">åŠ è½½ä¸­...</div></div>
                    <div id="pagination" class="pagination"></div>
                </div>
            </div>
            <div class="sidebar">
                <div class="card" id="sidebarUserCard">
                    <p style="color: var(--text-secondary); font-size: 14px;">è¯·ç™»å½•åæŸ¥çœ‹ä¸ªäººä¿¡æ¯</p>
                </div>
                <div class="card" id="hotRankCard">
                    <h2 style="font-size: 15px; display: flex; align-items: center; gap: 6px;">ğŸ”¥ çƒ­åº¦æ¦œ</h2>
                    <div id="hotRankList"><div class="loading">åŠ è½½ä¸­...</div></div>
                </div>
            </div>
        </div>

        <!-- ====== å‘å¸–é¡µ ====== -->
        <div id="page-create-post" class="page">
            <div class="card" style="max-width: 700px; margin: 0 auto;">
                <h2>âœï¸ å‘å¸ƒæ–°å¸–å­</h2>
                <div class="form-group" style="margin-bottom: 12px;">
                    <input type="text" id="postTitle" placeholder="æ ‡é¢˜">
                </div>
                <div class="form-group" style="margin-bottom: 12px;">
                    <textarea id="postContent" rows="10" placeholder="æ­£æ–‡å†…å®¹ (æ”¯æŒæ’å…¥å›¾ç‰‡)"></textarea>
                </div>
                <div class="upload-toolbar">
                    <label>
                        ğŸ–¼ï¸ æ’å…¥å›¾ç‰‡
                        <input type="file" accept="image/jpg,image/jpeg,image/png,image/gif" style="display:none;" onchange="doUploadImage(this, 'post')">
                    </label>
                    <span class="upload-status" id="postUploadStatus"></span>
                </div>
                <div class="image-preview-area" id="postImagePreview"></div>
                <div style="display: flex; gap: 10px;">
                    <button onclick="doCreatePost()" class="success">å‘å¸ƒ</button>
                    <button onclick="navigateTo('feed')" class="ghost">å–æ¶ˆ</button>
                </div>
            </div>
        </div>

        <!-- ====== å¸–å­è¯¦æƒ…é¡µ ====== -->
        <div id="page-post-detail" class="page main-layout">
            <div class="post-detail">
                <div class="card" id="postDetailCard">
                    <div class="loading">åŠ è½½ä¸­...</div>
                </div>
                <div class="card comment-section" id="commentSection">
                    <h3>ğŸ’¬ è¯„è®º</h3>
                    <div class="comment-input-area" id="commentInputArea">
                        <textarea id="commentContent" rows="3" placeholder="å†™ä¸‹ä½ çš„è¯„è®º..."></textarea>
                        <div class="upload-toolbar">
                            <label>
                                ğŸ–¼ï¸ æ’å…¥å›¾ç‰‡
                                <input type="file" accept="image/jpg,image/jpeg,image/png,image/gif" style="display:none;" onchange="doUploadImage(this, 'comment')">
                            </label>
                            <span class="upload-status" id="commentUploadStatus"></span>
                        </div>
                        <div class="image-preview-area" id="commentImagePreview"></div>
                        <div><button onclick="doCreateComment()" class="small">å‘è¡¨è¯„è®º</button></div>
                    </div>
                    <div id="commentList"></div>
                </div>
            </div>
            <div class="sidebar">
                <div class="card" id="postSidebarInfo"></div>
            </div>
        </div>

        <!-- ====== ç”¨æˆ·ä¸»é¡µ ====== -->
        <div id="page-user-profile" class="page">
            <div class="card" style="max-width: 700px; margin: 0 auto;" id="userProfileCard">
                <div class="loading">åŠ è½½ä¸­...</div>
            </div>
        </div>

        <!-- ====== æˆ‘çš„ä¸»é¡µ ====== -->
        <div id="page-my-profile" class="page">
            <div style="max-width: 700px; margin: 0 auto;">
                <div class="card" id="myProfileCard">
                    <div class="loading">åŠ è½½ä¸­...</div>
                </div>
                <div class="card">
                    <div class="feed-tabs">
                        <button id="myTabPosts" class="active" onclick="switchMyProfileTab('posts')">ğŸ“ æˆ‘çš„å¸–å­</button>
                        <button id="myTabFollowing" onclick="switchMyProfileTab('following')">ğŸ‘¥ å…³æ³¨</button>
                        <button id="myTabFollowers" onclick="switchMyProfileTab('followers')">ğŸ§‘â€ğŸ¤â€ğŸ§‘ ç²‰ä¸</button>
                    </div>
                    <div id="myProfileTabContent"></div>
                </div>
            </div>
        </div>

        <!-- ====== è®¾ç½®é¡µ ====== -->
        <div id="page-settings" class="page">
            <div style="max-width: 600px; margin: 0 auto;">
                <div class="card">
                    <h2>âœï¸ ä¿®æ”¹èµ„æ–™</h2>
                    <h3>ä¿®æ”¹æ˜µç§°</h3>
                    <div class="form-row">
                        <input type="text" id="newName" placeholder="æ–°æ˜µç§°">
                        <button onclick="doChangeName()">ä¿®æ”¹</button>
                    </div>
                    <h3>ä¿®æ”¹ä¸ªæ€§ç­¾å</h3>
                    <div class="form-row">
                        <input type="text" id="newIntro" placeholder="æ–°ç­¾å">
                        <button onclick="doChangeIntro()">ä¿®æ”¹</button>
                    </div>
                    <h3>ä¿®æ”¹å¤´åƒ</h3>
                    <div class="form-row" style="align-items: center;">
                        <input type="file" id="newAvatarFile" accept="image/*" style="border: none; padding: 0;">
                        <button onclick="doChangeAvatar()">ä¸Šä¼ </button>
                    </div>
                </div>
                <div class="card">
                    <h2>ğŸ”’ ä¿®æ”¹å¯†ç </h2>
                    <div class="form-group" style="margin-bottom: 10px;">
                        <input type="password" id="newPass1" placeholder="æ–°å¯†ç ">
                    </div>
                    <div class="form-group" style="margin-bottom: 10px;">
                        <input type="password" id="newPass2" placeholder="ç¡®è®¤æ–°å¯†ç ">
                    </div>
                    <button onclick="doChangePassword()" class="danger">é‡ç½®å¯†ç </button>
                </div>
                <div class="card">
                    <h2>âš ï¸ å±é™©æ“ä½œ</h2>
                    <button onclick="doDeleteUser()" class="danger">æ³¨é”€è´¦å·</button>
                </div>
                <div class="card" id="adminPanel" class="hidden">
                    <h2>ğŸ›¡ï¸ ç®¡ç†å‘˜æ“ä½œ</h2>
                    <h3>ç¦è¨€/è§£ç¦ç”¨æˆ·</h3>
                    <div class="form-row">
                        <input type="text" id="muteUserId" placeholder="ç”¨æˆ·ID (æ•°å­—)">
                        <button onclick="doMute(true)">ç¦è¨€</button>
                        <button onclick="doMute(false)" class="ghost">è§£ç¦</button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Toast -->
    <div id="toast" class="toast"></div>

    <!-- æ—¥å¿—é¢æ¿ -->
    <div id="logPanel" class="log-panel">
        <div class="log-header" onclick="toggleLog()">
            <span>ğŸ“¡ è¯·æ±‚æ—¥å¿—</span>
            <button onclick="event.stopPropagation(); document.getElementById('logContent').innerText=''" style="font-size: 11px; padding: 2px 8px; background: #555;">æ¸…ç©º</button>
        </div>
        <div class="log-content" id="logContent"></div>
    </div>
    <button class="log-toggle" onclick="toggleLog()" title="è¯·æ±‚æ—¥å¿—">ğŸ“¡</button>

    <script>
        // ===================== çŠ¶æ€ç®¡ç† =====================
        let currentPage = 'feed';
        let currentPostId = null;
        let currentViewUserId = null;
        let feedPage = 1;
        let feedTab = 'latest'; // 'latest' | 'following'
        let myProfileTab = 'posts'; // 'posts' | 'following' | 'followers'
        let myRole = 0;
        let myProfileData = null;

        // ===================== å·¥å…·å‡½æ•° =====================
        function getBaseUrl() {
            return document.getElementById('baseUrl').value.replace(/\/$/, '');
        }

        function getToken() {
            return localStorage.getItem('token') || '';
        }

        function isLoggedIn() {
            return !!getToken();
        }

        function resolveAvatar(avatar) {
            if (!avatar) return 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect fill="%23ddd" width="100" height="100"/><text x="50" y="55" text-anchor="middle" fill="%23999" font-size="40">?</text></svg>';
            if (avatar.startsWith('http')) return avatar;
            return getBaseUrl() + avatar;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text || '';
            return div.innerHTML;
        }

        // æ¸²æŸ“å¯Œæ–‡æœ¬å†…å®¹ï¼ˆæ”¯æŒ ![img](url) å›¾ç‰‡è¯­æ³•ï¼‰
        function renderRichContent(text) {
            if (!text) return '';
            let html = escapeHtml(text);
            // å°† ![img](url) è½¬æ¢ä¸º <img> æ ‡ç­¾
            html = html.replace(/!\[img\]\((.*?)\)/g, '<img src="$1" alt="å›¾ç‰‡" onclick="window.open(this.src)">');
            return html;
        }

        // ä¸Šä¼ å›¾ç‰‡åˆ°æœåŠ¡å™¨ï¼Œæ’å…¥åˆ°å…‰æ ‡ä½ç½®
        async function doUploadImage(inputEl, target) {
            const file = inputEl.files[0];
            if (!file) return;
            const statusEl = document.getElementById(target + 'UploadStatus');
            const textareaId = target === 'post' ? 'postContent' : 'commentContent';
            const textarea = document.getElementById(textareaId);
            statusEl.textContent = 'â³ ä¸Šä¼ ä¸­...';

            const formData = new FormData();
            formData.append('file', file);
            const res = await request('/account/protected/upload', 'POST', formData);

            inputEl.value = ''; // æ¸…ç©º file input ä»¥ä¾¿é‡å¤é€‰æ‹©åŒä¸€æ–‡ä»¶
            if (res && res.data && res.data.url) {
                const url = res.data.url;
                // åœ¨å…‰æ ‡ä½ç½®æ’å…¥å›¾ç‰‡æ ‡è®°
                insertAtCursor(textarea, `![img](${url})`);
                // æ›´æ–°é¢„è§ˆ
                renderImagePreviewFromText(target);
                statusEl.textContent = 'âœ… å·²æ’å…¥';
                setTimeout(() => { statusEl.textContent = ''; }, 2000);
            } else {
                statusEl.textContent = 'âŒ ä¸Šä¼ å¤±è´¥';
                setTimeout(() => { statusEl.textContent = ''; }, 3000);
            }
        }

        // åœ¨ textarea å…‰æ ‡ä½ç½®æ’å…¥æ–‡æœ¬
        function insertAtCursor(textarea, text) {
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const before = textarea.value.substring(0, start);
            const after = textarea.value.substring(end);
            // å¦‚æœå…‰æ ‡å‰ä¸æ˜¯æ¢è¡Œæˆ–å¼€å¤´ï¼Œå…ˆåŠ ä¸€ä¸ªæ¢è¡Œ
            const prefix = (before.length > 0 && !before.endsWith('\n')) ? '\n' : '';
            // æ’å…¥åä¹ŸåŠ ä¸€ä¸ªæ¢è¡Œï¼Œæ–¹ä¾¿ç»§ç»­è¾“å…¥
            const suffix = (after.length > 0 && !after.startsWith('\n')) ? '\n' : '';
            textarea.value = before + prefix + text + suffix + after;
            // ç§»åŠ¨å…‰æ ‡åˆ°æ’å…¥å†…å®¹ä¹‹å
            const newPos = before.length + prefix.length + text.length + suffix.length;
            textarea.selectionStart = textarea.selectionEnd = newPos;
            textarea.focus();
        }

        // ä» textarea å†…å®¹è§£æå›¾ç‰‡ URL å¹¶æ¸²æŸ“é¢„è§ˆ
        function renderImagePreviewFromText(target) {
            const textareaId = target === 'post' ? 'postContent' : 'commentContent';
            const content = document.getElementById(textareaId).value;
            const container = document.getElementById(target + 'ImagePreview');
            const regex = /!\[img\]\((.*?)\)/g;
            const images = [];
            let match;
            while ((match = regex.exec(content)) !== null) {
                images.push(match[1]);
            }
            if (images.length === 0) {
                container.innerHTML = '';
                return;
            }
            container.innerHTML = images.map(url => `
                <div class="preview-item">
                    <img src="${url}" alt="é¢„è§ˆ">
                </div>
            `).join('');
        }

        // ===================== Toast =====================
        function showToast(msg, type = 'info') {
            const el = document.getElementById('toast');
            el.textContent = msg;
            el.className = 'toast show' + (type === 'error' ? ' error' : type === 'success' ? ' success' : '');
            setTimeout(() => { el.className = 'toast'; }, 3000);
        }

        // ===================== æ—¥å¿— =====================
        function toggleLog() {
            document.getElementById('logPanel').classList.toggle('open');
        }

        function logRequest(title, data, isError = false) {
            const el = document.getElementById('logContent');
            const time = new Date().toLocaleTimeString();
            const content = typeof data === 'object' ? JSON.stringify(data, null, 2) : String(data);
            const prefix = isError ? 'âŒ' : 'âœ…';
            el.textContent = `[${time}] ${prefix} ${title}\n${content}\n${'â”€'.repeat(50)}\n` + el.textContent;
        }

        // ===================== HTTP è¯·æ±‚ =====================
        async function request(endpoint, method = 'GET', data = null) {
            const url = getBaseUrl() + endpoint;
            const headers = {};
            const token = getToken();
            if (token) headers['Authorization'] = 'Bearer ' + token;

            const options = { method, headers, credentials: 'include' };

            if (data instanceof FormData) {
                options.body = data;
            } else {
                headers['Content-Type'] = 'application/json';
                if (data) options.body = JSON.stringify(data);
            }

            logRequest(`>>> ${method} ${endpoint}`, data instanceof FormData ? '[FormData]' : (data || '(no body)'));

            try {
                const res = await fetch(url, options);
                const resData = await res.json();

                if (resData.code === 0) {
                    logRequest(`<<< ${res.status} ${endpoint}`, resData);
                    return resData;
                } else {
                    logRequest(`<<< ${res.status} ${endpoint}`, resData, true);
                    showToast(resData.msg || 'æ“ä½œå¤±è´¥', 'error');

                    // Token è¿‡æœŸè‡ªåŠ¨åˆ·æ–°
                    if (res.status === 200 && (resData.msg || '').includes('token')) {
                        const refreshed = await tryRefreshToken();
                        if (refreshed) {
                            return request(endpoint, method, data); // é‡è¯•
                        }
                    }
                    return null;
                }
            } catch (error) {
                logRequest(`<<< Network Error ${endpoint}`, String(error), true);
                showToast('ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥åç«¯æ˜¯å¦å¯åŠ¨', 'error');
                return null;
            }
        }

        async function tryRefreshToken() {
            try {
                const res = await fetch(getBaseUrl() + '/account/refresh', {
                    method: 'POST',
                    credentials: 'include',
                });
                const data = await res.json();
                if (data.code === 0 && data.data && data.data.access_token) {
                    localStorage.setItem('token', data.data.access_token);
                    showToast('Token å·²è‡ªåŠ¨åˆ·æ–°', 'success');
                    return true;
                }
            } catch (e) { /* ignore */ }
            return false;
        }

        // ===================== å¯¼èˆª =====================
        function navigateTo(page, params) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            const el = document.getElementById('page-' + page);
            if (el) el.classList.add('active');
            currentPage = page;

            // éœ€è¦ç™»å½•çš„é¡µé¢
            const protectedPages = ['create-post', 'my-profile', 'settings'];
            if (protectedPages.includes(page) && !isLoggedIn()) {
                navigateTo('auth');
                showToast('è¯·å…ˆç™»å½•', 'error');
                return;
            }

            switch (page) {
                case 'feed': loadFeed(); break;
                case 'auth': break;
                case 'create-post': break;
                case 'post-detail': loadPostDetail(params); break;
                case 'user-profile': loadUserProfile(params); break;
                case 'my-profile': loadMyProfile(); break;
                case 'settings': loadSettings(); break;
            }
        }

        function updateNavbar() {
            document.getElementById('navGuest').classList.toggle('hidden', isLoggedIn());
            document.getElementById('navUser').classList.toggle('hidden', !isLoggedIn());
        }

        // ===================== è®¤è¯ =====================
        function switchAuthTab(tab) {
            document.getElementById('formLogin').classList.toggle('hidden', tab !== 'login');
            document.getElementById('formRegister').classList.toggle('hidden', tab !== 'register');
            document.getElementById('tabLogin').classList.toggle('active', tab === 'login');
            document.getElementById('tabRegister').classList.toggle('active', tab === 'register');
        }

        async function doRegister() {
            const account = document.getElementById('regAccount').value.trim();
            const name = document.getElementById('regName').value.trim();
            const password = document.getElementById('regPassword').value;
            if (!account || !name || !password) return showToast('è¯·å¡«å†™å®Œæ•´', 'error');

            const res = await request('/account/register', 'POST', { account, name, password });
            if (res) {
                showToast('æ³¨å†ŒæˆåŠŸï¼Œè¯·ç™»å½•', 'success');
                switchAuthTab('login');
                document.getElementById('loginAccount').value = account;
            }
        }

        async function doLogin() {
            const account = document.getElementById('loginAccount').value.trim();
            const password = document.getElementById('loginPassword').value;
            if (!account || !password) return showToast('è¯·å¡«å†™å®Œæ•´', 'error');

            const res = await request('/account/login', 'POST', { account, password });
            if (res) {
                let token = '';
                if (typeof res.data === 'string') token = res.data;
                else if (res.data && res.data.token) token = res.data.token;

                if (token) {
                    localStorage.setItem('token', token);
                    updateNavbar();
                    showToast('ç™»å½•æˆåŠŸ', 'success');
                    navigateTo('feed');
                } else {
                    showToast('ç™»å½•å¼‚å¸¸ï¼šæ—  Token', 'error');
                }
            }
        }

        async function doLogout() {
            await request('/account/protected/logout', 'POST');
            localStorage.removeItem('token');
            myRole = 0;
            updateNavbar();
            showToast('å·²é€€å‡ºç™»å½•', 'success');
            navigateTo('feed');
        }

        // ===================== å¸–å­åˆ—è¡¨ =====================
        function switchFeedTab(tab) {
            feedTab = tab;
            feedPage = 1;
            document.getElementById('tabLatest').classList.toggle('active', tab === 'latest');
            document.getElementById('tabFollowing').classList.toggle('active', tab === 'following');
            loadFeed();
        }

        async function loadFeed(page) {
            if (page !== undefined) feedPage = page;
            updateSidebar();
            loadHotRank();

            if (feedTab === 'following') {
                await loadFollowingFeed();
                return;
            }

            const res = await request(`/account/protected/posts?page=${feedPage}`, 'GET');
            const listEl = document.getElementById('postList');
            const pageEl = document.getElementById('pagination');

            if (!res || !res.data || res.data.length === 0) {
                listEl.innerHTML = '<div class="loading">æš‚æ— å¸–å­</div>';
                pageEl.innerHTML = '';
                return;
            }

            renderPostList(res.data, listEl);
            renderPagination(res.data, pageEl);
        }

        async function loadFollowingFeed() {
            if (!isLoggedIn()) {
                document.getElementById('postList').innerHTML = '<div class="loading">è¯·å…ˆç™»å½•æŸ¥çœ‹å…³æ³¨åŠ¨æ€</div>';
                document.getElementById('pagination').innerHTML = '';
                return;
            }
            const res = await request(`/account/protected/following_post?page=${feedPage}`, 'GET');
            const listEl = document.getElementById('postList');
            const pageEl = document.getElementById('pagination');

            if (!res || !res.data || typeof res.data === 'string' || res.data.length === 0) {
                listEl.innerHTML = '<div class="loading">æš‚æ— å…³æ³¨åŠ¨æ€ï¼Œå»å…³æ³¨ä¸€äº›äººå§~</div>';
                pageEl.innerHTML = '';
                return;
            }

            renderPostList(res.data, listEl);
            renderPagination(res.data, pageEl);
        }

        function renderPostList(posts, container) {
            container.innerHTML = posts.map(post => `
                <div class="post-item" onclick="navigateTo('post-detail', ${post.post_id})">
                    <div class="post-meta">
                        <img src="${resolveAvatar(post.avatar)}" alt="">
                        <span class="author-name" onclick="event.stopPropagation()">${escapeHtml(post.name)}</span>
                    </div>
                    <div class="post-title">${escapeHtml(post.title)}</div>
                    <div class="post-stats">
                        <span>ğŸ‘€ ${post.view_count || 0}</span>
                        <span>ğŸ‘ ${post.like_count || 0}</span>
                        <span>ğŸ’¬ ${post.comment_count || 0}</span>
                    </div>
                </div>
            `).join('');
        }

        function renderPagination(data, container) {
            container.innerHTML = `
                ${feedPage > 1 ? `<button class="small ghost" onclick="loadFeed(${feedPage - 1})">ä¸Šä¸€é¡µ</button>` : ''}
                <span style="padding: 8px; font-size: 14px;">ç¬¬ ${feedPage} é¡µ</span>
                ${data.length >= 10 ? `<button class="small ghost" onclick="loadFeed(${feedPage + 1})">ä¸‹ä¸€é¡µ</button>` : ''}
            `;
        }

        async function updateSidebar() {
            const el = document.getElementById('sidebarUserCard');
            if (!isLoggedIn()) {
                el.innerHTML = '<p style="color: var(--text-secondary); font-size: 14px;">ç™»å½•åæŸ¥çœ‹ä¸ªäººä¿¡æ¯</p>';
                return;
            }
            const res = await request('/account/protected/profile', 'GET');
            if (res && res.data) {
                const u = res.data;
                myRole = u.role || 0;
                el.innerHTML = `
                    <div class="user-card" onclick="navigateTo('my-profile')" style="cursor:pointer;">
                        <img src="${resolveAvatar(u.avatar)}">
                        <div>
                            <div class="name">${escapeHtml(u.name)}</div>
                            <div class="role">${u.role === 1 ? 'ğŸ›¡ï¸ ç®¡ç†å‘˜' : 'ğŸ‘¤ ç”¨æˆ·'} ${u.isMuted ? 'ğŸ”‡ å·²ç¦è¨€' : ''}</div>
                        </div>
                    </div>
                    <p style="font-size: 13px; color: var(--text-secondary); margin-top: 8px;">${escapeHtml(u.introduction) || 'è¿™ä¸ªäººå¾ˆæ‡’ï¼Œä»€ä¹ˆéƒ½æ²¡å†™'}</p>
                    <ul class="menu">
                        <li onclick="navigateTo('my-profile')">ğŸ“‹ æˆ‘çš„ä¸»é¡µ</li>
                        <li onclick="navigateTo('settings')">âš™ è®¾ç½®</li>
                        <li onclick="navigateTo('create-post')">âœï¸ å‘å¸–</li>
                    </ul>
                `;
            }
        }

        // ===================== çƒ­åº¦æ¦œ =====================
        async function loadHotRank() {
            const el = document.getElementById('hotRankList');
            if (!isLoggedIn()) {
                el.innerHTML = '<p style="color: var(--text-secondary); font-size: 13px;">ç™»å½•åæŸ¥çœ‹çƒ­åº¦æ¦œ</p>';
                return;
            }
            const res = await request('/account/protected/hot_rank', 'GET');
            if (!res || !res.data || res.data.length === 0) {
                el.innerHTML = '<p style="color: var(--text-secondary); font-size: 13px;">æš‚æ— çƒ­é—¨å¸–å­</p>';
                return;
            }
            el.innerHTML = res.data.map((item, idx) => {
                const p = item.post;
                const score = Math.round(item.score * 10) / 10;
                const rankClass = idx === 0 ? 'top1' : idx === 1 ? 'top2' : idx === 2 ? 'top3' : 'normal';
                return `
                    <div class="hot-rank-item" onclick="navigateTo('post-detail', ${p.post_id})">
                        <div class="rank-num ${rankClass}">${idx + 1}</div>
                        <div class="rank-info">
                            <div class="rank-title">${escapeHtml(p.title)}</div>
                            <div class="rank-score">ğŸ”¥ ${score} &nbsp; ğŸ‘€${p.view_count || 0} ğŸ‘${p.like_count || 0} ğŸ’¬${p.comment_count || 0}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ===================== å‘å¸– =====================
        async function doCreatePost() {
            const title = document.getElementById('postTitle').value.trim();
            const content = document.getElementById('postContent').value.trim();
            if (!title || !content) return showToast('æ ‡é¢˜å’Œå†…å®¹ä¸èƒ½ä¸ºç©º', 'error');

            const res = await request('/account/protected/posts', 'POST', { Title: title, Content: content });
            if (res) {
                showToast('å‘å¸ƒæˆåŠŸ', 'success');
                document.getElementById('postTitle').value = '';
                document.getElementById('postContent').value = '';
                document.getElementById('postImagePreview').innerHTML = '';
                navigateTo('feed');
            }
        }

        // ===================== å¸–å­è¯¦æƒ… =====================
        async function loadPostDetail(postId) {
            if (postId !== undefined) currentPostId = postId;
            const card = document.getElementById('postDetailCard');
            const commentList = document.getElementById('commentList');
            const sideInfo = document.getElementById('postSidebarInfo');

            card.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';

            const res = await request(`/account/protected/posts/${currentPostId}`, 'GET');
            if (!res || !res.data) {
                card.innerHTML = '<div class="loading">å¸–å­ä¸å­˜åœ¨æˆ–åŠ è½½å¤±è´¥</div>';
                return;
            }

            const p = res.data;
            const canDelete = isLoggedIn(); // å…·ä½“æƒé™åç«¯ä¼šåˆ¤æ–­

            card.innerHTML = `
                <div class="post-header">
                    <h1>${escapeHtml(p.title)}</h1>
                    <div class="post-author">
                        <img src="${resolveAvatar(p.avatar)}" onclick="navigateTo('user-profile', ${p.user_id})">
                        <div class="info">
                            <div class="name" onclick="navigateTo('user-profile', ${p.user_id})">${escapeHtml(p.name)}</div>
                            <div style="font-size: 12px; color: var(--text-secondary);">
                                ğŸ‘€ ${p.view_count || 0} &nbsp; ğŸ‘ ${p.like_count || 0} &nbsp; ğŸ’¬ ${p.comment_count || 0}
                            </div>
                        </div>
                    </div>
                </div>
                <div class="post-content rich-content">${renderRichContent(p.content)}</div>
                <div class="post-actions">
                    <button class="small ghost" onclick="navigateTo('feed')">â† è¿”å›åˆ—è¡¨</button>
                    ${isLoggedIn() ? `<button class="small ghost like-btn" id="likeBtn" onclick="doToggleLike(${p.post_id})">ğŸ‘ ç‚¹èµ <span id="likeCount">${p.like_count || 0}</span></button>` : ''}
                    ${canDelete ? `<button class="small ghost-danger" onclick="doDeletePost(${p.post_id})">ğŸ—‘ åˆ é™¤å¸–å­</button>` : ''}
                </div>
            `;

            // è¯„è®ºåˆ—è¡¨
            const comments = p.comment || [];
            if (comments.length === 0) {
                commentList.innerHTML = '<p style="color: var(--text-secondary); padding: 10px 0;">æš‚æ— è¯„è®ºï¼Œå¿«æ¥æŠ¢æ²™å‘~</p>';
            } else {
                commentList.innerHTML = comments.map(c => `
                    <div class="comment-item">
                        <img src="${resolveAvatar(c.user_avatar)}" onclick="navigateTo('user-profile', ${c.user_id})">
                        <div class="comment-body">
                            <div class="comment-author" onclick="navigateTo('user-profile', ${c.user_id})">${escapeHtml(c.user_name)}</div>
                            <div class="comment-text rich-content">${renderRichContent(c.content)}</div>
                            <div class="comment-time">${c.created_at || ''}</div>
                            <div class="comment-actions">
                                <button class="small ghost-danger" onclick="doDeleteComment(${c.id}, ${p.user_id})">åˆ é™¤</button>
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            // ä¾§è¾¹ä½œè€…ä¿¡æ¯
            sideInfo.innerHTML = `
                <div style="text-align: center;">
                    <img src="${resolveAvatar(p.avatar)}" style="width: 64px; height: 64px; border-radius: 50%; object-fit: cover; cursor: pointer;" onclick="navigateTo('user-profile', ${p.user_id})">
                    <p style="font-weight: 600; margin-top: 8px;">${escapeHtml(p.name)}</p>
                    <div style="display: flex; gap: 8px; justify-content: center; margin-top: 10px;">
                        <button class="small ghost" onclick="navigateTo('user-profile', ${p.user_id})">æŸ¥çœ‹ä¸»é¡µ</button>
                        ${isLoggedIn() ? `<button class="small ghost follow-btn" id="postFollowBtn" onclick="doFollowFromPost(${p.user_id})">â• å…³æ³¨</button>` : ''}
                    </div>
                </div>
            `;

            // æœªç™»å½•éšè—è¯„è®ºæ¡†
            document.getElementById('commentInputArea').classList.toggle('hidden', !isLoggedIn());
        }

        // ===================== å‘è¡¨è¯„è®º =====================
        async function doCreateComment() {
            const content = document.getElementById('commentContent').value.trim();
            if (!content) return showToast('è¯„è®ºä¸èƒ½ä¸ºç©º', 'error');

            const res = await request(`/account/protected/posts/${currentPostId}`, 'POST', { Content: content });
            if (res) {
                showToast('è¯„è®ºæˆåŠŸ', 'success');
                document.getElementById('commentContent').value = '';
                document.getElementById('commentImagePreview').innerHTML = '';
                loadPostDetail(); // åˆ·æ–°
            }
        }

        // ===================== åˆ é™¤å¸–å­ =====================
        async function doDeletePost(postId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ç¯‡å¸–å­å—ï¼Ÿ')) return;
            const res = await request(`/account/protected/posts/${postId}`, 'DELETE');
            if (res) {
                showToast('å¸–å­å·²åˆ é™¤', 'success');
                navigateTo('feed');
            }
        }

        // ===================== åˆ é™¤è¯„è®º =====================
        async function doDeleteComment(commentId, posterId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è¯„è®ºå—ï¼Ÿ')) return;
            // è·¯ç”±: DELETE /posts/:postId/:posterId/:commentId
            const res = await request(`/account/protected/posts/${currentPostId}/${posterId}/${commentId}`, 'DELETE');
            if (res) {
                showToast('è¯„è®ºå·²åˆ é™¤', 'success');
                loadPostDetail(); // åˆ·æ–°
            }
        }

        // ===================== ç‚¹èµ =====================
        async function doToggleLike(postId) {
            if (!isLoggedIn()) return showToast('è¯·å…ˆç™»å½•', 'error');
            const res = await request(`/account/protected/posts/${postId}/like`, 'POST');
            if (res && res.data) {
                const likeBtn = document.getElementById('likeBtn');
                const likeCount = document.getElementById('likeCount');
                if (likeBtn) {
                    if (res.data.isLike) {
                        likeBtn.classList.add('liked');
                        likeBtn.innerHTML = `â¤ï¸ å·²èµ <span id="likeCount">${res.data.count}</span>`;
                    } else {
                        likeBtn.classList.remove('liked');
                        likeBtn.innerHTML = `ğŸ‘ ç‚¹èµ <span id="likeCount">${res.data.count}</span>`;
                    }
                }
                showToast(res.data.isLike ? 'ç‚¹èµæˆåŠŸ' : 'å·²å–æ¶ˆç‚¹èµ', 'success');
            }
        }

        // ===================== å…³æ³¨ =====================
        async function doFollow(userId) {
            if (!isLoggedIn()) return showToast('è¯·å…ˆç™»å½•', 'error');
            const res = await request(`/account/protected/follow/${userId}`, 'POST');
            if (res && res.data !== undefined) {
                const isFollow = res.data.isFollow;
                showToast(isFollow ? 'å…³æ³¨æˆåŠŸ' : 'å·²å–å…³', 'success');
                return isFollow;
            }
            return null;
        }

        async function doFollowFromPost(userId) {
            const isFollow = await doFollow(userId);
            if (isFollow !== null) {
                const btn = document.getElementById('postFollowBtn');
                if (btn) {
                    if (isFollow) {
                        btn.classList.add('following');
                        btn.textContent = 'âœ… å·²å…³æ³¨';
                    } else {
                        btn.classList.remove('following');
                        btn.textContent = 'â• å…³æ³¨';
                    }
                }
            }
        }

        async function doFollowFromProfile(userId) {
            const isFollow = await doFollow(userId);
            if (isFollow !== null) {
                const btn = document.getElementById('profileFollowBtn');
                if (btn) {
                    if (isFollow) {
                        btn.classList.add('following');
                        btn.textContent = 'âœ… å·²å…³æ³¨';
                    } else {
                        btn.classList.remove('following');
                        btn.textContent = 'â• å…³æ³¨';
                    }
                }
            }
        }

        // ===================== ç”¨æˆ·ä¸»é¡µ (å…¶ä»–äºº) =====================
        async function loadUserProfile(userId) {
            if (userId !== undefined) currentViewUserId = userId;
            const card = document.getElementById('userProfileCard');
            card.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';

            const res = await request(`/account/protected/users/${currentViewUserId}`, 'GET');
            if (!res || !res.data) {
                card.innerHTML = '<div class="loading">ç”¨æˆ·ä¸å­˜åœ¨</div>';
                return;
            }

            const u = res.data;
            // ç®¡ç†å‘˜æ“ä½œæŒ‰é’®
            const adminActions = myRole === 1 ? `
                <div style="margin: 12px 0; padding: 12px; background: #fff3cd; border-radius: 6px; border: 1px solid #ffc107;">
                    <span style="font-size: 13px; font-weight: 600;">ğŸ›¡ï¸ ç®¡ç†å‘˜æ“ä½œï¼š</span>
                    ${u.isMuted
                        ? `<button class="small success" onclick="doMuteFromProfile(${currentViewUserId}, false)" style="margin-left: 8px;">ğŸ”Š è§£é™¤ç¦è¨€</button>`
                        : `<button class="small danger" onclick="doMuteFromProfile(${currentViewUserId}, true)" style="margin-left: 8px;">ğŸ”‡ ç¦è¨€è¯¥ç”¨æˆ·</button>`
                    }
                </div>
            ` : '';

            card.innerHTML = `
                <div class="profile-header">
                    <img src="${resolveAvatar(u.avatar)}">
                    <div class="info">
                        <h2>${escapeHtml(u.name)}
                            <span class="badge" style="background:${u.role === 1 ? '#ff9800' : '#2196f3'};color:white;">${u.role === 1 ? 'ç®¡ç†å‘˜' : 'ç”¨æˆ·'}</span>
                            ${u.isMuted ? '<span class="badge" style="background:#f44336;color:white;">å·²ç¦è¨€</span>' : ''}
                        </h2>
                        <p>è´¦å·: ${escapeHtml(u.account)}</p>
                        <p>${escapeHtml(u.introduction) || 'è¿™ä¸ªäººå¾ˆæ‡’ï¼Œä»€ä¹ˆéƒ½æ²¡å†™'}</p>
                    </div>
                </div>
                <div style="margin: 12px 0; display: flex; gap: 8px; align-items: center;">
                    ${isLoggedIn() ? `<button class="small ghost follow-btn" id="profileFollowBtn" onclick="doFollowFromProfile(${currentViewUserId})">â• å…³æ³¨</button>` : ''}
                    <button class="small ghost" onclick="navigateTo('feed')">â† è¿”å›</button>
                </div>
                ${adminActions}
                <h3 style="margin: 16px 0 12px;">ğŸ“ Taçš„å¸–å­ (${(u.posts || []).length})</h3>
                ${(u.posts || []).length === 0 ? '<p style="color: var(--text-secondary);">æš‚æ— å¸–å­</p>' :
                    (u.posts || []).map(post => `
                        <div class="post-item" onclick="navigateTo('post-detail', ${post.post_id})">
                            <div class="post-title">${escapeHtml(post.title)}</div>
                            <div class="post-stats">
                                <span>ğŸ‘€ ${post.view_count || 0}</span>
                                <span>ğŸ‘ ${post.like_count || 0}</span>
                                <span>ğŸ’¬ ${post.comment_count || 0}</span>
                            </div>
                        </div>
                    `).join('')
                }
            `;
        }

        // ===================== æˆ‘çš„ä¸»é¡µ =====================
        async function loadMyProfile() {
            const card = document.getElementById('myProfileCard');
            card.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';

            const res = await request('/account/protected/profile', 'GET');
            if (!res || !res.data) {
                card.innerHTML = '<div class="loading">åŠ è½½å¤±è´¥</div>';
                return;
            }

            const u = res.data;
            myRole = u.role || 0;
            myProfileData = u;
            card.innerHTML = `
                <div class="profile-header">
                    <img src="${resolveAvatar(u.avatar)}">
                    <div class="info">
                        <h2>${escapeHtml(u.name)}
                            <span class="badge" style="background:${u.role === 1 ? '#ff9800' : '#2196f3'};color:white;">${u.role === 1 ? 'ç®¡ç†å‘˜' : 'ç”¨æˆ·'}</span>
                            ${u.isMuted ? '<span class="badge" style="background:#f44336;color:white;">å·²ç¦è¨€</span>' : ''}
                        </h2>
                        <p>è´¦å·: ${escapeHtml(u.account)}</p>
                        <p>${escapeHtml(u.introduction) || 'è¿™ä¸ªäººå¾ˆæ‡’ï¼Œä»€ä¹ˆéƒ½æ²¡å†™'}</p>
                    </div>
                </div>
                <div style="margin: 12px 0; display: flex; gap: 8px;">
                    <button class="small ghost" onclick="navigateTo('settings')">âœï¸ ç¼–è¾‘èµ„æ–™</button>
                    <button class="small success" onclick="navigateTo('create-post')">âœï¸ å‘å¸–</button>
                </div>
            `;

            // é»˜è®¤æ˜¾ç¤ºå¸–å­ tab
            myProfileTab = 'posts';
            document.getElementById('myTabPosts').classList.add('active');
            document.getElementById('myTabFollowing').classList.remove('active');
            document.getElementById('myTabFollowers').classList.remove('active');
            renderMyProfileTabContent();
        }

        function switchMyProfileTab(tab) {
            myProfileTab = tab;
            document.getElementById('myTabPosts').classList.toggle('active', tab === 'posts');
            document.getElementById('myTabFollowing').classList.toggle('active', tab === 'following');
            document.getElementById('myTabFollowers').classList.toggle('active', tab === 'followers');
            renderMyProfileTabContent();
        }

        async function renderMyProfileTabContent() {
            const container = document.getElementById('myProfileTabContent');

            if (myProfileTab === 'posts') {
                const u = myProfileData;
                if (!u || (u.posts || []).length === 0) {
                    container.innerHTML = '<p style="color: var(--text-secondary); padding: 16px 0;">æš‚æ— å¸–å­ï¼Œå»å‘å¸ƒä¸€ç¯‡å§~</p>';
                } else {
                    container.innerHTML = (u.posts || []).map(post => `
                        <div class="post-item" onclick="navigateTo('post-detail', ${post.post_id})">
                            <div class="post-title">${escapeHtml(post.title)}</div>
                            <div class="post-stats">
                                <span>ğŸ‘€ ${post.view_count || 0}</span>
                                <span>ğŸ‘ ${post.like_count || 0}</span>
                                <span>ğŸ’¬ ${post.comment_count || 0}</span>
                            </div>
                        </div>
                    `).join('');
                }
            } else if (myProfileTab === 'following') {
                container.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
                const res = await request('/account/protected/following', 'GET');
                if (!res || !res.data || typeof res.data === 'string') {
                    container.innerHTML = '<p style="color: var(--text-secondary); padding: 16px 0;">è¿˜æ²¡æœ‰å…³æ³¨çš„äºº~</p>';
                } else {
                    container.innerHTML = renderFollowList(res.data);
                }
            } else if (myProfileTab === 'followers') {
                container.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
                const res = await request('/account/protected/follow', 'GET');
                if (!res || !res.data || typeof res.data === 'string') {
                    container.innerHTML = '<p style="color: var(--text-secondary); padding: 16px 0;">è¿˜æ²¡æœ‰ç²‰ä¸~</p>';
                } else {
                    container.innerHTML = renderFollowList(res.data);
                }
            }
        }

        function renderFollowList(users) {
            return users.map(u => `
                <div class="follow-list-item">
                    <img src="${resolveAvatar(u.avatar)}" onclick="navigateTo('user-profile', ${u.user_id})">
                    <div class="follow-info">
                        <div class="follow-name" onclick="navigateTo('user-profile', ${u.user_id})">${escapeHtml(u.name)}</div>
                        <div class="follow-intro">${escapeHtml(u.introduction) || 'è¿™ä¸ªäººå¾ˆæ‡’ï¼Œä»€ä¹ˆéƒ½æ²¡å†™'}</div>
                    </div>
                    <button class="small ghost" onclick="navigateTo('user-profile', ${u.user_id})">æŸ¥çœ‹</button>
                </div>
            `).join('');
        }

        // ===================== è®¾ç½®é¡µ =====================
        function loadSettings() {
            // ç®¡ç†å‘˜é¢æ¿æ˜¾ç¤º
            const adminPanel = document.getElementById('adminPanel');
            if (myRole === 1) {
                adminPanel.classList.remove('hidden');
            } else {
                adminPanel.classList.add('hidden');
            }
        }

        async function doChangeName() {
            const name = document.getElementById('newName').value.trim();
            if (!name) return showToast('æ˜µç§°ä¸èƒ½ä¸ºç©º', 'error');
            const res = await request('/account/protected/username', 'PATCH', { name });
            if (res) { showToast('æ˜µç§°ä¿®æ”¹æˆåŠŸ', 'success'); document.getElementById('newName').value = ''; }
        }

        async function doChangeIntro() {
            const introduction = document.getElementById('newIntro').value.trim();
            if (!introduction) return showToast('ç­¾åä¸èƒ½ä¸ºç©º', 'error');
            const res = await request('/account/protected/introduction', 'PATCH', { introduction });
            if (res) { showToast('ç­¾åä¿®æ”¹æˆåŠŸ', 'success'); document.getElementById('newIntro').value = ''; }
        }

        async function doChangeAvatar() {
            const fileInput = document.getElementById('newAvatarFile');
            if (fileInput.files.length === 0) return showToast('è¯·é€‰æ‹©å›¾ç‰‡', 'error');
            const formData = new FormData();
            formData.append('avatar', fileInput.files[0]);
            const res = await request('/account/protected/avatar', 'POST', formData);
            if (res) { showToast('å¤´åƒä¿®æ”¹æˆåŠŸ', 'success'); }
        }

        async function doChangePassword() {
            const pw1 = document.getElementById('newPass1').value;
            const pw2 = document.getElementById('newPass2').value;
            if (!pw1 || !pw2) return showToast('è¯·è¾“å…¥å¯†ç ', 'error');
            if (pw1 !== pw2) return showToast('ä¸¤æ¬¡å¯†ç ä¸ä¸€è‡´', 'error');
            const res = await request('/account/protected/password-change', 'POST', {
                first_password: pw1,
                second_password: pw2
            });
            if (res) {
                showToast('å¯†ç ä¿®æ”¹æˆåŠŸ', 'success');
                document.getElementById('newPass1').value = '';
                document.getElementById('newPass2').value = '';
            }
        }

        async function doDeleteUser() {
            if (!confirm('ç¡®å®šè¦æ³¨é”€è´¦å·å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return;
            const res = await request('/account/protected/delete-user', 'DELETE');
            if (res) {
                showToast('è´¦å·å·²æ³¨é”€', 'success');
                localStorage.removeItem('token');
                myRole = 0;
                updateNavbar();
                navigateTo('auth');
            }
        }

        // ===================== ç¦è¨€ =====================
        async function doMute(isMuted) {
            const userId = document.getElementById('muteUserId').value.trim();
            if (!userId) return showToast('è¯·è¾“å…¥ç”¨æˆ·ID', 'error');
            const res = await request(`/account/protected/muted/${userId}`, 'POST', { is_muted: isMuted });
            if (res) {
                showToast(isMuted ? 'å·²ç¦è¨€' : 'å·²è§£ç¦', 'success');
            }
        }

        async function doMuteFromProfile(userId, isMuted) {
            const action = isMuted ? 'ç¦è¨€' : 'è§£ç¦';
            if (!confirm(`ç¡®å®šè¦${action}è¯¥ç”¨æˆ·å—ï¼Ÿ`)) return;
            const res = await request(`/account/protected/muted/${userId}`, 'POST', { is_muted: isMuted });
            if (res) {
                showToast(`å·²${action}`, 'success');
                loadUserProfile(); // åˆ·æ–°å½“å‰ç”¨æˆ·ä¸»é¡µ
            }
        }

        // ===================== åˆå§‹åŒ– =====================
        updateNavbar();
        if (isLoggedIn()) {
            navigateTo('feed');
        } else {
            navigateTo('feed');
        }

        // é”®ç›˜å¿«æ·é”®ï¼šEnter ç™»å½•
        document.getElementById('loginPassword').addEventListener('keydown', e => { if (e.key === 'Enter') doLogin(); });
        document.getElementById('regPassword').addEventListener('keydown', e => { if (e.key === 'Enter') doRegister(); });

        // textarea å†…å®¹å˜åŒ–æ—¶å®æ—¶æ›´æ–°å›¾ç‰‡é¢„è§ˆ
        document.getElementById('postContent').addEventListener('input', () => renderImagePreviewFromText('post'));
        document.getElementById('commentContent').addEventListener('input', () => renderImagePreviewFromText('comment'));
    </script>
</body>
</html>